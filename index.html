<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Craxxy5909's Serv ‚Äî Statut</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .card {
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    h1 {
      margin: 0 0 10px;
      font-size: 22px;
      color: #38bdf8;
    }
    .status {
      margin: 10px 0;
      font-weight: bold;
      padding: 8px;
      border-radius: 6px;
      text-align: center;
    }
    .online {
      background: #064e3b;
      color: #4ade80;
    }
    .offline {
      background: #581c1c;
      color: #f87171;
    }
    .info {
      margin: 10px 0;
      padding: 8px;
      background: #0f172a;
      border-radius: 6px;
    }
    button {
      background: #38bdf8;
      color: #0f172a;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
    }
    button:hover {
      background: #0ea5e9;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üåç Craxxy5909's Serv (modd√©)</h1>
    <div id="status" class="status">Chargement...</div>
    <div class="info">
      <strong>Joueurs :</strong> <span id="players">‚Äî</span>
    </div>
    <div class="info">
      <strong>Version :</strong> <span id="version">‚Äî</span>
    </div>
    <div class="info">
      <strong>MOTD :</strong> <span id="motd">‚Äî</span>
    </div>
    <button onclick="checkServer()">üîÑ Rafra√Æchir</button>
    <p style="font-size:12px;color:#94a3b8;margin-top:10px;">
      V√©rification automatique toutes les 15 secondes.<br>
      <strong>‚ö†Ô∏è Autorisez les notifications dans votre navigateur.</strong>
    </p>
  </div>

  <script>
    const SERVER = '91.197.5.218:27390';
    const API = 'http://localhost:3000/status';

    let lastOnline = null; // true/false
    let lastPlayers = [];  // anciens pseudos

    // Demander permission notification au chargement
    if ("Notification" in window) {
      if (Notification.permission === "default") {
        Notification.requestPermission();
      }
    }

    function notify(title, body) {
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification(title, { body: body });
      }
    }

    async function checkServer() {
      const statusEl = document.getElementById('status');
      const playersEl = document.getElementById('players');
      const versionEl = document.getElementById('version');
      const motdEl = document.getElementById('motd');

      try {
        const res = await fetch(API, { cache: "no-store" });
        const data = await res.json();

        if (data.online) {
          statusEl.textContent = "‚úÖ EN LIGNE";
          statusEl.className = "status online";

          playersEl.textContent = data.players.online + " / " + data.players.max;
          versionEl.textContent = data.version || "‚Äî";
          motdEl.textContent = (data.motd && data.motd.clean) ? data.motd.clean.join(" ") : "‚Äî";

          // --- Notifications ---
          if (lastOnline === false) {
            notify("Serveur en ligne ‚úÖ", "Craxxy5909's Serv vient de d√©marrer !");
          }
          if (Array.isArray(data.players.list)) {
            const current = data.players.list;
            // nouveaux joueurs connect√©s
            current.forEach(p => {
              if (!lastPlayers.includes(p)) {
                notify("üë§ Connexion", p + " vient de rejoindre le serveur.");
              }
            });
            // joueurs d√©connect√©s
            lastPlayers.forEach(p => {
              if (!current.includes(p)) {
                notify("üëã D√©connexion", p + " a quitt√© le serveur.");
              }
            });
            lastPlayers = current;
          } else {
            lastPlayers = [];
          }
          lastOnline = true;

        } else {
          statusEl.textContent = "‚ùå HORS LIGNE";
          statusEl.className = "status offline";
          playersEl.textContent = "‚Äî";
          versionEl.textContent = "‚Äî";
          motdEl.textContent = "‚Äî";

          if (lastOnline === true) {
            notify("Serveur arr√™t√© ‚ùå", "Craxxy5909's Serv vient de s'√©teindre.");
          }
          lastOnline = false;
          lastPlayers = [];
        }
      } catch (err) {
        statusEl.textContent = "‚ö†Ô∏è Erreur (API inaccessible)";
        statusEl.className = "status offline";
      }
    }

    // premi√®re v√©rif + toutes les 15s
    checkServer();
    setInterval(checkServer, 15000);
  </script>
</body>
</html>
